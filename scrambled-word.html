<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrambled Word Game - Advanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5deb3 0%, #fffacd 50%, #faebd7 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .mode-section {
            margin-bottom: 20px;
        }

        .mode-section h2 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #555;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .mode-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .mode-btn.solo {
            border-color: #27ae60;
        }

        .mode-btn.solo.selected {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .mode-btn.team {
            border-color: #3498db;
        }

        .mode-btn.team.selected {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .mode-info {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            color: #555;
            text-align: center;
        }

        .setup-section {
            margin-bottom: 20px;
            display: none;
        }

        .setup-section h2 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #555;
        }

        .difficulty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .difficulty-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .difficulty-btn.easy {
            border-color: #27ae60;
        }

        .difficulty-btn.easy.selected {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .difficulty-btn.normal {
            border-color: #f39c12;
        }

        .difficulty-btn.normal.selected {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .difficulty-btn.hard {
            border-color: #e74c3c;
        }

        .difficulty-btn.hard.selected {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .difficulty-info {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            color: #555;
            text-align: center;
        }

        .btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-red {
            background: #e74c3c;
            color: white;
        }

        .btn-blue {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-gift {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            animation: giftPulse 1.5s infinite;
        }

        @keyframes giftPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .scoreboard {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            gap: 20px;
        }

        .team {
            flex: 1;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .team-red {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .team-blue {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .solo-score {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .team-score {
            font-size: 48px;
            margin-top: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .difficulty-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }

        .badge-easy {
            background: #27ae60;
            color: white;
        }

        .badge-normal {
            background: #f39c12;
            color: white;
        }

        .badge-hard {
            background: #e74c3c;
            color: white;
        }

        .game-section {
            display: none;
        }

        .hint-box {
            background: #fff9e6;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 3px dashed #f39c12;
            text-align: center;
        }

        .hint-label {
            color: #f39c12;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .hint-text {
            color: #333;
            font-size: 22px;
            font-style: italic;
        }

        .letters-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
            min-height: 80px;
        }

        .letter-btn {
            width: 60px;
            height: 60px;
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-transform: uppercase;
        }

        .letter-btn:hover:not(:disabled) {
            transform: scale(1.1) rotate(5deg);
        }

        .letter-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .answer-container {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #34495e;
        }

        .answer-text {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 5px;
            text-transform: uppercase;
        }

        .answer-letter {
            display: inline-block;
            min-width: 30px;
        }

        .answer-letter.prefilled {
            color: #27ae60;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .team-buttons {
            display: none;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            animation: slideDown 0.5s ease;
        }

        .solo-buttons {
            display: none;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .shake {
            animation: shake 0.5s;
        }

        .bounce {
            animation: bounce 0.5s;
        }

        .pulse {
            animation: pulse 0.5s;
        }

        .feedback {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 15px 0;
            min-height: 30px;
        }

        .feedback.correct {
            color: #27ae60;
        }

        .feedback.wrong {
            color: #e74c3c;
        }

        .progress {
            text-align: center;
            font-size: 18px;
            color: #7f8c8d;
            margin: 10px 0;
        }

        .timer-container {
            text-align: center;
            margin: 15px 0;
        }

        .timer {
            display: inline-block;
            font-size: 36px;
            font-weight: bold;
            padding: 15px 30px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            min-width: 100px;
        }

        .timer.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            animation: timerPulse 1s infinite;
        }

        .timer.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            animation: timerPulse 0.5s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .bonus-points {
            display: inline-block;
            margin-left: 10px;
            font-size: 18px;
            color: #27ae60;
            font-weight: bold;
        }

        .gift-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .gift-content {
            background: white;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            animation: bounce 1s;
        }

        .gift-content h2 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .gift-result {
            font-size: 32px;
            font-weight: bold;
            margin: 20px 0;
            color: #f39c12;
        }

        .gift-description {
            font-size: 18px;
            margin: 20px 0;
            color: #555;
        }

        .gift-team-select {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .winner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .winner-content {
            background: white;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            animation: bounce 1s;
        }

        .winner-content h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #f39c12;
        }

        .winner-team {
            font-size: 36px;
            font-weight: bold;
            margin: 20px 0;
        }

        .final-scores {
            font-size: 24px;
            margin: 20px 0;
            color: #555;
            line-height: 1.5;
        }

        .game-mode-info {
            background: #f0f4ff;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 18px;
            color: #555;
        }

        .vocab-info-display {
            background: #e8f6f3;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 16px;
            color: #27ae60;
            text-align: center;
        }

        /* Logo Animation */
        .logo-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            animation: swing 3s ease-in-out infinite;
        }

        .logo-container img {
            width: 180px;
            height: auto;
            object-fit: contain;
            border-radius: 10px;
        }

        @keyframes swing {
            0%, 100% { 
                transform: rotate(0deg);
            }
            25% { 
                transform: rotate(10deg);
            }
            75% { 
                transform: rotate(-10deg);
            }
        }

        .hidden {
            display: none;
        }

        /* CSS cho ph·∫ßn t·ª´ ƒëi·ªÉn */
        .vocabulary-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #3498db;
        }

        .vocab-controls {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .vocab-select {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #3498db;
            border-radius: 5px;
            background: white;
            min-width: 180px;
        }

        .load-vocab-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .load-vocab-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .vocab-info {
            background: #e8f4fc;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
            color: #2c3e50;
        }

        .vocab-preview {
            background: #e8f6f3;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
            color: #27ae60;
            text-align: center;
        }

        .vocab-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .letter-btn {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }

            .answer-text {
                font-size: 28px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 16px;
            }

            .logo-container img {
                width: 60px;
                height: 60px;
            }

            .difficulty-btn, .mode-btn {
                padding: 12px 20px;
                font-size: 16px;
            }

            .vocab-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .vocab-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Scrambled Word Game üéÆ</h1>

        <!-- Mode Selection Section -->
        <div class="mode-section" id="modeSection">
            <h2>üë• Select Game Mode</h2>
            <div class="mode-selector">
                <button class="mode-btn solo" onclick="selectMode('solo')">
                    üéØ SOLO PLAYER
                </button>
                <button class="mode-btn team selected" onclick="selectMode('team')">
                    üë• 2 TEAMS
                </button>
            </div>
            <div class="mode-info" id="modeInfo">
                <strong>2 TEAMS:</strong> Compete in teams - Red vs Blue
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="proceedToSetup()">‚û°Ô∏è CONTINUE</button>
            </div>
        </div>

        <!-- Setup Section -->
        <div class="setup-section" id="setupSection">
            <h2>üéØ Select Difficulty Level</h2>
            <div class="difficulty-selector">
                <button class="difficulty-btn easy" onclick="selectDifficulty('easy')">
                    üòä EASY
                </button>
                <button class="difficulty-btn normal selected" onclick="selectDifficulty('normal')">
                    üòê NORMAL
                </button>
                <button class="difficulty-btn hard" onclick="selectDifficulty('hard')">
                    üòà HARD
                </button>
            </div>
            <div class="difficulty-info" id="difficultyInfo">
                <strong>NORMAL:</strong> Standard game mode
            </div>

            <!-- Ph·∫ßn t·ª´ ƒëi·ªÉn - Ch·ªâ t·∫£i t·ª´ vocabulary.txt -->
            <div class="vocabulary-section">
                <h2>üìö Select Vocabulary</h2>
                <div id="vocabStatus" class="vocab-status status-loading">
                    ‚è≥ Loading vocabulary from file...
                </div>
                
                <div class="vocab-controls">
                    <select id="levelSelect" class="vocab-select" disabled>
                        <option value="">-- Select Level --</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                    
                    <select id="unitSelect" class="vocab-select" disabled>
                        <option value="">-- Select Unit --</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                    
                    <button class="load-vocab-btn" onclick="loadVocabulary()" disabled>
                        üì• LOAD VOCABULARY
                    </button>
                </div>
                
                <div id="vocabPreview" class="vocab-preview" style="display: none;">
                    ‚úÖ Vocabulary loaded! Click START GAME to play.
                </div>
                
                <div class="vocab-info">
                    <strong>Vocabulary source:</strong> vocabulary.txt file
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="startGame()" id="startGameBtn" disabled>üöÄ START GAME</button>
                <button class="btn btn-secondary" onclick="goBackToModeSelection()">‚¨ÖÔ∏è BACK</button>
            </div>
        </div>

        <!-- Game Section -->
        <div class="game-section" id="gameSection">
            <!-- Scoreboard -->
            <div class="scoreboard" id="scoreboard">
                <!-- This will be filled dynamically based on game mode -->
            </div>

            <!-- Th√¥ng tin Level v√† Unit ƒëang ch∆°i -->
            <div id="currentVocabInfo" class="vocab-info-display" style="display: none;">
                üìö Playing: <span id="currentLevelDisplay">-</span> | üìñ Unit: <span id="currentUnitDisplay">-</span>
            </div>

            <!-- Progress -->
            <div class="progress" id="progress">
                Word 1 / 10
                <span class="difficulty-badge" id="difficultyBadge"></span>
            </div>

            <!-- Timer -->
            <div class="timer-container">
                <div class="timer" id="timer">30</div>
                <span class="bonus-points" id="bonusPoints"></span>
            </div>

            <!-- Hint -->
            <div class="hint-box">
                <div class="hint-label">üí° HINT:</div>
                <div class="hint-text" id="hintText">...</div>
            </div>

            <!-- Scrambled Letters -->
            <div class="letters-container" id="lettersContainer"></div>

            <!-- Answer -->
            <div class="answer-container">
                <div class="answer-text" id="answerText">___</div>
            </div>

            <!-- Feedback -->
            <div class="feedback" id="feedback"></div>

            <!-- Team Selection Buttons -->
            <div class="team-buttons" id="teamButtons">
                <button class="btn btn-red" onclick="addToTeam('red')">‚ûï ADD TO RED TEAM</button>
                <button class="btn btn-blue" onclick="addToTeam('blue')">‚ûï ADD TO BLUE TEAM</button>
                <button class="btn btn-gift" onclick="openGiftBox()">üéÅ MYSTERY GIFT</button>
            </div>

            <!-- Solo Player Buttons -->
            <div class="solo-buttons" id="soloButtons">
                <button class="btn btn-success" onclick="addToSolo()">‚ûï ADD TO MY SCORE</button>
                <button class="btn btn-gift" onclick="openGiftBox()">üéÅ MYSTERY GIFT</button>
            </div>

            <!-- Next Button (shown after team selection) -->
            <div style="text-align: center; margin: 20px 0; display: none;" id="nextButtonContainer">
                <button class="btn btn-primary" onclick="nextWord()">‚û°Ô∏è NEXT WORD</button>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-success" onclick="checkAnswer()">‚úì CHECK</button>
                <button class="btn btn-secondary" onclick="clearAnswer()">üîÑ CLEAR</button>
                <button class="btn btn-secondary" onclick="skipWord()">‚è≠Ô∏è SKIP</button>
            </div>
        </div>

        <!-- Gift Modal -->
        <div class="gift-modal" id="giftModal">
            <div class="gift-content">
                <h2>üéÅ</h2>
                <div class="gift-result" id="giftResult"></div>
                <div class="gift-description" id="giftDescription"></div>
                
                <div class="gift-team-select" id="giftTeamSelect" style="display: none;">
                    <p style="margin-bottom: 15px; font-size: 18px;">Choose which team gets the gift:</p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="btn btn-red" onclick="applyGiftToTeam('red')">üî¥ RED TEAM</button>
                        <button class="btn btn-blue" onclick="applyGiftToTeam('blue')">üîµ BLUE TEAM</button>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="giftOkButton" onclick="applyGift()">OK</button>
            </div>
        </div>

        <!-- Winner Modal -->
        <div class="winner-modal" id="winnerModal">
            <div class="winner-content">
                <h2>üéâ CONGRATULATIONS!</h2>
                <div class="winner-team" id="winnerTeam"></div>
                
                <div id="vocabularyInfo" class="vocab-info-display" style="margin: 20px 0; font-size: 20px; padding: 15px;">
                    üìö <strong>Vocabulary:</strong> <span id="finalLevel">-</span> | üìñ <strong>Unit:</strong> <span id="finalUnit">-</span>
                </div>
                
                <div class="game-mode-info" id="gameModeInfo"></div>
                <div class="final-scores" id="finalScores"></div>
                <button class="btn btn-primary" onclick="playAgain()">üîÑ PLAY AGAIN</button>
            </div>
        </div>
    </div>

    <!-- Logo -->
    <div class="logo-container">
        <img src="logo.png" alt="Logo">
    </div>

    <script>
        let words = [];
        let currentIndex = 0;
        let currentWord = '';
        let currentAnswer = '';
        let redTeamScore = 0;
        let blueTeamScore = 0;
        let soloScore = 0;
        let correctAnswer = false;
        let currentPoints = 0;
        let difficulty = 'normal';
        let gameMode = 'team';
        let prefilledPositions = [];
        let giftType = '';
        let selectedTeam = '';
        let timeLeft = 30;
        let timerInterval = null;
        let bonusPoints = 0;
        
        // Bi·∫øn cho t·ª´ ƒëi·ªÉn
        let vocabularyData = "";
        let selectedLevel = "";
        let selectedUnit = "";
        let vocabularyLoaded = false;
        let vocabularyStructure = {}; // L∆∞u c·∫•u tr√∫c t·ª´ ƒëi·ªÉn

        // Audio elements
        const rightSound = new Audio('right.mp3');
        const wrongSound = new Audio('wrong.mp3');
        const winSound = new Audio('win.mp3');

        // Kh·ªüi t·∫°o - T·ª± ƒë·ªông t·∫£i vocabulary.txt
        document.addEventListener('DOMContentLoaded', function() {
            loadVocabularyFile();
        });

        // H√†m t·∫£i file vocabulary.txt
        async function loadVocabularyFile() {
            const statusDiv = document.getElementById('vocabStatus');
            const levelSelect = document.getElementById('levelSelect');
            const unitSelect = document.getElementById('unitSelect');
            const loadBtn = document.querySelector('.load-vocab-btn');
            const startBtn = document.getElementById('startGameBtn');
            
            try {
                statusDiv.className = 'vocab-status status-loading';
                statusDiv.textContent = '‚è≥ Loading vocabulary from file...';
                
                // T·∫£i file vocabulary.txt
                const response = await fetch('vocabulary.txt');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const fileContent = await response.text();
                
                if (!fileContent.trim()) {
                    throw new Error('File is empty');
                }
                
                vocabularyData = fileContent;
                vocabularyLoaded = true;
                
                // Parse c·∫•u tr√∫c t·ª´ ƒëi·ªÉn
                parseVocabularyStructure();
                
                // C·∫≠p nh·∫≠t status
                statusDiv.className = 'vocab-status status-success';
                statusDiv.textContent = '‚úÖ Vocabulary file loaded successfully!';
                
                // Enable c√°c control
                levelSelect.disabled = false;
                levelSelect.innerHTML = '<option value="">-- Select Level --</option>';
                
                // Th√™m c√°c level v√†o dropdown
                for (const level in vocabularyStructure) {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = level;
                    levelSelect.appendChild(option);
                }
                
                // Event listener cho level select
                levelSelect.addEventListener('change', function() {
                    if (this.value) {
                        // Update unit select
                        unitSelect.disabled = false;
                        loadBtn.disabled = false;
                        
                        // Clear v√† th√™m units
                        unitSelect.innerHTML = '<option value="">-- Select Unit --</option>';
                        const units = Object.keys(vocabularyStructure[this.value]);
                        units.forEach(unit => {
                            const option = document.createElement('option');
                            option.value = unit;
                            option.textContent = unit;
                            unitSelect.appendChild(option);
                        });
                    } else {
                        unitSelect.disabled = true;
                        loadBtn.disabled = true;
                    }
                });
                
                console.log('Vocabulary file loaded successfully');
                
            } catch (error) {
                console.error('Error loading vocabulary file:', error);
                vocabularyLoaded = false;
                
                statusDiv.className = 'vocab-status status-error';
                statusDiv.textContent = '‚ùå Error loading vocabulary file. Please ensure vocabulary.txt exists in the same folder.';
                
                // Disable t·∫•t c·∫£
                levelSelect.disabled = true;
                unitSelect.disabled = true;
                loadBtn.disabled = true;
                startBtn.disabled = true;
            }
        }

        // Parse c·∫•u tr√∫c t·ª´ ƒëi·ªÉn ƒë·ªÉ l·∫•y danh s√°ch Level v√† Unit
        function parseVocabularyStructure() {
            vocabularyStructure = {};
            const lines = vocabularyData.split('\n');
            let currentLevel = '';
            let currentUnit = '';
            
            for (let line of lines) {
                line = line.trim();
                
                // T√¨m level m·ªõi
                if (line.startsWith('===') && line.endsWith('===')) {
                    currentLevel = line.replace(/===/g, '').trim();
                    vocabularyStructure[currentLevel] = {};
                    currentUnit = '';
                }
                // T√¨m unit m·ªõi
                else if (line.startsWith('[') && line.endsWith(']') && currentLevel) {
                    currentUnit = line.slice(1, -1).trim();
                    vocabularyStructure[currentLevel][currentUnit] = [];
                }
                // Th√™m t·ª´ v·ª±ng
                else if (line.includes('|') && currentLevel && currentUnit) {
                    vocabularyStructure[currentLevel][currentUnit].push(line);
                }
            }
        }

        // Load t·ª´ ƒëi·ªÉn t·ª´ Level v√† Unit ƒë√£ ch·ªçn
        function loadVocabulary() {
            const level = document.getElementById('levelSelect').value;
            const unit = document.getElementById('unitSelect').value;
            const startBtn = document.getElementById('startGameBtn');
            
            if (!level || !unit) {
                alert('Please select both Level and Unit');
                return;
            }
            
            // L∆∞u th√¥ng tin level v√† unit ƒë√£ ch·ªçn
            selectedLevel = level;
            selectedUnit = unit;
            
            // L·∫•y t·ª´ v·ª±ng t·ª´ c·∫•u tr√∫c
            const vocabList = vocabularyStructure[level][unit];
            
            if (!vocabList || vocabList.length === 0) {
                alert(`No vocabulary found for ${level} - ${unit}`);
                return;
            }
            
            // Parse t·ª´ v·ª±ng
            words = [];
            for (let line of vocabList) {
                const parts = line.split('|').map(s => s.trim());
                if (parts.length >= 2 && parts[0] && parts[1]) {
                    words.push({
                        word: parts[0].toLowerCase(),
                        hint: parts[1]
                    });
                }
            }
            
            if (words.length === 0) {
                alert('No valid words found!');
                return;
            }
            
            // Hi·ªÉn th·ªã th√¥ng b√°o
            document.getElementById('vocabPreview').style.display = 'block';
            document.getElementById('vocabPreview').textContent = 
                `‚úÖ Loaded ${words.length} words from ${level} - ${unit}`;
            
            // Enable start game button
            startBtn.disabled = false;
            
            // Scroll ƒë·∫øn n√∫t start game
            startBtn.scrollIntoView({ behavior: 'smooth' });
        }

        function selectMode(mode) {
            gameMode = mode;
            
            // Update button styles
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // Update info text
            const infoText = {
                'solo': '<strong>SOLO PLAYER:</strong> Play alone and beat your own high score! üéØ',
                'team': '<strong>2 TEAMS:</strong> Compete with friends - Red team vs Blue team! üë•'
            };
            document.getElementById('modeInfo').innerHTML = infoText[mode];
        }

        function proceedToSetup() {
            // Ki·ªÉm tra xem ƒë√£ t·∫£i ƒë∆∞·ª£c t·ª´ ƒëi·ªÉn ch∆∞a
            if (!vocabularyLoaded) {
                alert('Vocabulary file is still loading or not found. Please ensure vocabulary.txt exists in the same folder.');
                return;
            }
            
            document.getElementById('modeSection').style.display = 'none';
            document.getElementById('setupSection').style.display = 'block';
        }

        function goBackToModeSelection() {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('modeSection').style.display = 'block';
        }

        function selectDifficulty(level) {
            difficulty = level;
            
            // Update button styles
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // Update info text
            const infoText = {
                'easy': '<strong>EASY:</strong> First and last letters are revealed! üéØ',
                'normal': '<strong>NORMAL:</strong> Standard game mode üòä',
                'hard': '<strong>HARD:</strong> 3 extra random letters added! üòà'
            };
            document.getElementById('difficultyInfo').innerHTML = infoText[level];
        }

        function startGame() {
                console.log('DEBUG: Starting game with', words.length, 'words');
                console.log('DEBUG: Game state - currentIndex:', currentIndex, 'currentWord:', currentWord);
    // KI·ªÇM TRA K·ª∏: N·∫øu words r·ªóng ho·∫∑c undefined
    if (!words || words.length === 0) {
        console.error('DEBUG: words array is empty!');
        alert('No vocabulary loaded! Please select Level and Unit, then click LOAD VOCABULARY.');
        return;
    }

    // ƒê·∫¢M B·∫¢O RESET HO√ÄN TO√ÄN TR∆Ø·ªöC KHI B·∫ÆT ƒê·∫¶U
    currentIndex = 0;
    redTeamScore = 0;
    blueTeamScore = 0;
    soloScore = 0;
    currentWord = '';
    currentAnswer = '';
    correctAnswer = false;
    currentPoints = 0;
    prefilledPositions = [];
    giftType = '';
    selectedTeam = '';
    timeLeft = 30;
    bonusPoints = 0;
                // Reset timer display
    const timerDiv = document.getElementById('timer');
    if (timerDiv) {
        timerDiv.textContent = '30';
        timerDiv.className = 'timer';
    }
            
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';

            // Set up scoreboard based on game mode
            setupScoreboard();
            
            // Hi·ªÉn th·ªã th√¥ng tin Level v√† Unit
            if (selectedLevel && selectedUnit) {
                document.getElementById('currentVocabInfo').style.display = 'block';
                document.getElementById('currentLevelDisplay').textContent = selectedLevel;
                document.getElementById('currentUnitDisplay').textContent = selectedUnit;
            }

            // Set difficulty badge
            const badge = document.getElementById('difficultyBadge');
            badge.textContent = difficulty.toUpperCase();
            badge.className = `difficulty-badge badge-${difficulty}`;

            loadWord();
        }

        function setupScoreboard() {
            const scoreboard = document.getElementById('scoreboard');
            
            if (gameMode === 'team') {
                scoreboard.innerHTML = `
                    <div class="team team-red">
                        <div>üî¥ RED TEAM</div>
                        <div class="team-score" id="redScore">0</div>
                    </div>
                    <div class="team team-blue">
                        <div>üîµ BLUE TEAM</div>
                        <div class="team-score" id="blueScore">0</div>
                    </div>
                `;
            } else {
                scoreboard.innerHTML = `
                    <div class="team solo-score" style="width: 100%; max-width: 400px; margin: 0 auto;">
                        <div>üéØ SOLO PLAYER</div>
                        <div class="team-score" id="soloScore">0</div>
                    </div>
                `;
            }
        }

        function loadWord() {
                // FIX BUG: Clean up tr∆∞·ªõc khi load t·ª´ m·ªõi
    stopTimer(); // ƒê·∫£m b·∫£o timer d·ª´ng
    
    // Reset answer v√† letters container
    currentAnswer = '';
    correctAnswer = false;
    prefilledPositions = [];
    
    // X√≥a c√°c letter buttons c≈©
    const container = document.getElementById('lettersContainer');
    if (container) {
        container.innerHTML = '';
    }
    
    // Reset UI elements
    document.getElementById('feedback').textContent = '';
    document.getElementById('feedback').className = 'feedback';
    document.getElementById('teamButtons').style.display = 'none';
    document.getElementById('soloButtons').style.display = 'none';
    document.getElementById('nextButtonContainer').style.display = 'none';
    document.getElementById('bonusPoints').textContent = '';
    
    // Reset answer display
    document.getElementById('answerText').textContent = '___';
    document.getElementById('answerText').className = 'answer-text';
            if (currentIndex >= words.length) {
                endGame();
                return;
            }

            const wordData = words[currentIndex];
            currentWord = wordData.word;
            currentAnswer = '';
            correctAnswer = false;
            currentPoints = currentWord.length;
            prefilledPositions = [];
            timeLeft = 30;
            bonusPoints = 0;

            // Apply difficulty modifications
            if (difficulty === 'easy') {
                // Prefill first and last letters
                currentAnswer = currentWord[0] + '_'.repeat(currentWord.length - 2) + currentWord[currentWord.length - 1];
                prefilledPositions = [0, currentWord.length - 1];
            }

            // Update UI
            document.getElementById('progress').innerHTML = `
                Word ${currentIndex + 1} / ${words.length}
                <span class="difficulty-badge badge-${difficulty}">${difficulty.toUpperCase()}</span>
            `;
            document.getElementById('hintText').textContent = wordData.hint;
            updateAnswerDisplay();
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';
            document.getElementById('teamButtons').style.display = 'none';
            document.getElementById('soloButtons').style.display = 'none';
            document.getElementById('nextButtonContainer').style.display = 'none';
            document.getElementById('bonusPoints').textContent = '';

            // Start timer
            startTimer();

            // Scramble and display letters
            displayScrambledLetters();
        }

        function startTimer() {
            // Clear any existing timer
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            updateTimerDisplay();

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    // Auto skip when time runs out
                    if (!correctAnswer) {
                        document.getElementById('feedback').textContent = '‚è∞ TIME\'S UP!';
                        document.getElementById('feedback').className = 'feedback wrong';
                        setTimeout(() => {
                            currentIndex++;
                            loadWord();
                        }, 1500);
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timerDiv = document.getElementById('timer');
            timerDiv.textContent = timeLeft;

            // Remove all classes
            timerDiv.classList.remove('warning', 'danger');

            // Add appropriate class based on time
            if (timeLeft <= 10) {
                timerDiv.classList.add('danger');
            } else if (timeLeft <= 20) {
                timerDiv.classList.add('warning');
            }

            // Calculate bonus points (1 point per 10 seconds remaining)
            if (timeLeft > 0) {
                bonusPoints = Math.floor(timeLeft / 10);
                if (bonusPoints > 0 && correctAnswer) {
                    document.getElementById('bonusPoints').textContent = `+${bonusPoints} bonus! ‚ö°`;
                }
            }
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function displayScrambledLetters() {
            const container = document.getElementById('lettersContainer');
            container.innerHTML = '';

            // Get letters to scramble (excluding prefilled ones for easy mode)
            let lettersToScramble = [];
            for (let i = 0; i < currentWord.length; i++) {
                if (!prefilledPositions.includes(i)) {
                    lettersToScramble.push(currentWord[i]);
                }
            }

            // Scramble letters
            const scrambled = lettersToScramble.sort(() => Math.random() - 0.5);

            // Add fake letters for hard mode
            if (difficulty === 'hard') {
                const fakeLetters = ['b', 'c', 'd', 'f', 'g', 'h', 'j', 'k', 'l', 'm', 'n', 'p', 'q', 'r', 's', 't', 'v', 'w', 'x', 'y', 'z'];
                for (let i = 0; i < 3; i++) {
                    const randomLetter = fakeLetters[Math.floor(Math.random() * fakeLetters.length)];
                    scrambled.splice(Math.floor(Math.random() * scrambled.length), 0, randomLetter);
                }
            }

            // Create buttons
            scrambled.forEach((letter, index) => {
                const btn = document.createElement('button');
                btn.className = 'letter-btn';
                btn.textContent = letter;
                btn.onclick = () => selectLetter(index);
                btn.id = `letter-${index}`;
                container.appendChild(btn);
            });
        }

        function selectLetter(index) {
            const btn = document.getElementById(`letter-${index}`);
            if (btn.disabled) return;

            const letter = btn.textContent;

            // For easy mode, insert at next available position
            if (difficulty === 'easy') {
                let inserted = false;
                let newAnswer = currentAnswer.split('');
                for (let i = 1; i < currentWord.length - 1; i++) {
                    if (newAnswer[i] === '_') {
                        newAnswer[i] = letter;
                        inserted = true;
                        break;
                    }
                }
                if (inserted) {
                    currentAnswer = newAnswer.join('');
                    btn.disabled = true;
                }
            } else {
                // Normal and hard mode
                currentAnswer += letter;
                btn.disabled = true;
            }

            updateAnswerDisplay();
        }

        function updateAnswerDisplay() {
            const answerDiv = document.getElementById('answerText');
            
            if (difficulty === 'easy') {
                // Display with prefilled letters highlighted
                let html = '';
                for (let i = 0; i < currentAnswer.length; i++) {
                    const char = currentAnswer[i];
                    if (prefilledPositions.includes(i)) {
                        html += `<span class="answer-letter prefilled">${char}</span>`;
                    } else {
                        html += `<span class="answer-letter">${char === '_' ? '_' : char}</span>`;
                    }
                }
                answerDiv.innerHTML = html;
            } else {
                answerDiv.textContent = currentAnswer || '___';
            }
        }

        function clearAnswer() {
            if (difficulty === 'easy') {
                // Reset to prefilled letters only
                currentAnswer = currentWord[0] + '_'.repeat(currentWord.length - 2) + currentWord[currentWord.length - 1];
            } else {
                currentAnswer = '';
            }
            
            updateAnswerDisplay();
            
            // Re-enable all letter buttons
            const buttons = document.querySelectorAll('.letter-btn');
            buttons.forEach(btn => btn.disabled = false);

            document.getElementById('feedback').textContent = '';
        }

        function checkAnswer() {
            if (!currentAnswer || (difficulty === 'easy' && currentAnswer.includes('_'))) {
                return;
            }

            const feedback = document.getElementById('feedback');
            const answerBox = document.getElementById('answerText');

            if (currentAnswer.toLowerCase() === currentWord.toLowerCase()) {
                // Stop timer
                stopTimer();

                // Correct answer
                correctAnswer = true;
                
                // Calculate bonus points
                bonusPoints = Math.floor(timeLeft / 10);
                
                let bonusText = bonusPoints > 0 ? ` (+${bonusPoints} time bonus!)` : '';
                feedback.textContent = 'üéâ CORRECT!' + bonusText + ' üéâ';
                feedback.className = 'feedback correct';
                answerBox.classList.add('bounce');
                
                if (bonusPoints > 0) {
                    document.getElementById('bonusPoints').textContent = `+${bonusPoints} bonus points! ‚ö°`;
                }
                
                rightSound.play().catch(e => console.log('Audio play failed:', e));

                // Show appropriate buttons based on game mode
                if (gameMode === 'team') {
                    document.getElementById('teamButtons').style.display = 'flex';
                } else {
                    document.getElementById('soloButtons').style.display = 'flex';
                }

                setTimeout(() => answerBox.classList.remove('bounce'), 500);
            } else {
                // Wrong answer
                feedback.textContent = '‚ùå WRONG! Try Again!';
                feedback.className = 'feedback wrong';
                answerBox.classList.add('shake');
                
                wrongSound.play().catch(e => console.log('Audio play failed:', e));

                setTimeout(() => {
                    answerBox.classList.remove('shake');
                    clearAnswer();
                }, 500);
            }
        }

        function addToTeam(team) {
            if (!correctAnswer) return;

            selectedTeam = team;
            
            // Add base points + bonus points
            const totalPoints = currentPoints + bonusPoints;

            if (team === 'red') {
                redTeamScore += totalPoints;
                document.getElementById('redScore').textContent = redTeamScore;
                document.querySelector('.team-red').classList.add('pulse');
                setTimeout(() => document.querySelector('.team-red').classList.remove('pulse'), 500);
            } else {
                blueTeamScore += totalPoints;
                document.getElementById('blueScore').textContent = blueTeamScore;
                document.querySelector('.team-blue').classList.add('pulse');
                setTimeout(() => document.querySelector('.team-blue').classList.remove('pulse'), 500);
            }

            // Hide team buttons and show next button
            document.getElementById('teamButtons').style.display = 'none';
            document.getElementById('nextButtonContainer').style.display = 'block';
        }

        function addToSolo() {
            if (!correctAnswer) return;
            
            // Add base points + bonus points
            const totalPoints = currentPoints + bonusPoints;
            soloScore += totalPoints;
            
            document.getElementById('soloScore').textContent = soloScore;
            document.querySelector('.solo-score').classList.add('pulse');
            setTimeout(() => document.querySelector('.solo-score').classList.remove('pulse'), 500);

            // Hide solo buttons and show next button
            document.getElementById('soloButtons').style.display = 'none';
            document.getElementById('nextButtonContainer').style.display = 'block';
        }

        function openGiftBox() {
            if (!correctAnswer) return;

            // Random gift: 0 = half points, 1 = double points, 2 = add points + continue
            const gifts = [
                {
                    type: 'half',
                    emoji: 'üò¢',
                    title: 'OOPS!',
                    description: 'You lose half of the points from this answer!'
                },
                {
                    type: 'double',
                    emoji: 'üéä',
                    title: 'JACKPOT!',
                    description: 'Your points are DOUBLED!'
                },
                {
                    type: 'continue',
                    emoji: 'üåü',
                    title: 'BONUS!',
                    description: 'Get the points AND play the next word!'
                }
            ];

            const randomGift = gifts[Math.floor(Math.random() * gifts.length)];
            giftType = randomGift.type;

            document.getElementById('giftResult').textContent = randomGift.emoji + ' ' + randomGift.title;
            document.getElementById('giftDescription').textContent = randomGift.description;
            document.getElementById('giftModal').style.display = 'flex';
            
            // Hi·ªÉn th·ªã ph·∫ßn ch·ªçn ƒë·ªôi n·∫øu l√† ch·∫ø ƒë·ªô team, ·∫©n n√∫t OK
            if (gameMode === 'team') {
                document.getElementById('giftTeamSelect').style.display = 'flex';
                document.getElementById('giftOkButton').style.display = 'none';
            } else {
                document.getElementById('giftTeamSelect').style.display = 'none';
                document.getElementById('giftOkButton').style.display = 'block';
            }
        }

        function applyGift() {
            document.getElementById('giftModal').style.display = 'none';

            // Ch·ªâ g·ªçi cho solo mode
            if (gameMode === 'solo') {
                applyGiftToSolo();
                return;
            }
        }

        function applyGiftToTeam(team) {
            document.getElementById('giftModal').style.display = 'none';
            
            // Calculate base points (with bonus)
            let basePoints = currentPoints + bonusPoints;
            let pointsToAdd = basePoints;

            if (giftType === 'half') {
                pointsToAdd = Math.floor(basePoints / 2);
            } else if (giftType === 'double') {
                pointsToAdd = basePoints * 2;
            }

            // Apply points to selected team
            if (team === 'red') {
                redTeamScore += pointsToAdd;
                document.getElementById('redScore').textContent = redTeamScore;
                document.querySelector('.team-red').classList.add('pulse');
                setTimeout(() => document.querySelector('.team-red').classList.remove('pulse'), 500);
            } else {
                blueTeamScore += pointsToAdd;
                document.getElementById('blueScore').textContent = blueTeamScore;
                document.querySelector('.team-blue').classList.add('pulse');
                setTimeout(() => document.querySelector('.team-blue').classList.remove('pulse'), 500);
            }

            // Hide team buttons
            document.getElementById('teamButtons').style.display = 'none';
            
            // For 'continue' gift type, we'll handle it in nextWord function
            if (giftType === 'continue') {
                alert('BONUS! You can play the next word now!');
            }
            
            document.getElementById('nextButtonContainer').style.display = 'block';
        }

        function applyGiftToSolo() {
            // Calculate base points (with bonus)
            let basePoints = currentPoints + bonusPoints;
            let pointsToAdd = basePoints;

            if (giftType === 'half') {
                pointsToAdd = Math.floor(basePoints / 2);
            } else if (giftType === 'double') {
                pointsToAdd = basePoints * 2;
            }

            // Apply points to solo player
            soloScore += pointsToAdd;
            document.getElementById('soloScore').textContent = soloScore;
            document.querySelector('.solo-score').classList.add('pulse');
            setTimeout(() => document.querySelector('.solo-score').classList.remove('pulse'), 500);

            // Hide solo buttons and show next button
            document.getElementById('soloButtons').style.display = 'none';
            
            // For 'continue' gift type, we'll handle it in nextWord function
            if (giftType === 'continue') {
                alert('BONUS! You can play the next word now!');
            }
            
            document.getElementById('nextButtonContainer').style.display = 'block';
        }

        function skipWord() {
            stopTimer();
            currentIndex++;
            loadWord();
        }

        function nextWord() {
            // Move to next word (or reload if continue gift)
            if (giftType === 'continue') {
                // Reset gift type and reload current word
                giftType = '';
                loadWord();
            } else {
                currentIndex++;
                loadWord();
            }
        }

        function endGame() {
            stopTimer();
            
            const modal = document.getElementById('winnerModal');
            const winnerTeam = document.getElementById('winnerTeam');
            const finalScores = document.getElementById('finalScores');
            const gameModeInfo = document.getElementById('gameModeInfo');
            const finalLevel = document.getElementById('finalLevel');
            const finalUnit = document.getElementById('finalUnit');

            let winner = '';
            let winnerColor = '';

            // Hi·ªÉn th·ªã th√¥ng tin Level v√† Unit
            if (selectedLevel && selectedUnit) {
                finalLevel.textContent = selectedLevel;
                finalUnit.textContent = selectedUnit;
                document.getElementById('vocabularyInfo').style.display = 'block';
            } else {
                document.getElementById('vocabularyInfo').style.display = 'none';
            }

            if (gameMode === 'team') {
                // Hi·ªÉn th·ªã th√¥ng tin ch·∫ø ƒë·ªô ch∆°i
                gameModeInfo.innerHTML = `<strong>Game Mode:</strong> 2 Teams | <strong>Difficulty:</strong> ${difficulty.toUpperCase()}`;
                
                if (redTeamScore > blueTeamScore) {
                    winner = 'üî¥ RED TEAM WINS! üî¥';
                    winnerColor = '#e74c3c';
                } else if (blueTeamScore > redTeamScore) {
                    winner = 'üîµ BLUE TEAM WINS! üîµ';
                    winnerColor = '#3498db';
                } else {
                    winner = 'ü§ù IT\'S A DRAW! ü§ù';
                    winnerColor = '#f39c12';
                }
                
                finalScores.innerHTML = `
                    <div>üî¥ Red Team: <strong>${redTeamScore}</strong> points</div>
                    <div>üîµ Blue Team: <strong>${blueTeamScore}</strong> points</div>
                    <div style="margin-top: 10px; font-size: 20px;">Total words played: <strong>${words.length}</strong></div>
                `;
            } else {
                // SOLO MODE
                gameModeInfo.innerHTML = `<strong>Game Mode:</strong> Solo Player | <strong>Difficulty:</strong> ${difficulty.toUpperCase()}`;
                
                winner = 'Well done!';
                winnerColor = '#27ae60';
                finalScores.innerHTML = `
                    <div>üéØ Your Final Score: <strong>${soloScore}</strong> points</div>
                    <div style="margin-top: 10px;">Total words completed: <strong>${words.length}</strong></div>
                    <div>Average score per word: <strong>${(soloScore / words.length).toFixed(1)}</strong> points</div>
                `;
            }

            winnerTeam.textContent = winner;
            winnerTeam.style.color = winnerColor;

            modal.style.display = 'flex';
            
            winSound.play().catch(e => console.log('Audio play failed:', e));
        }

function playAgain() {
    // Thay v√¨ reset ph·ª©c t·∫°p, ƒë∆°n gi·∫£n l√† refresh trang
    location.reload();
}
        // H√†m kh√¥i ph·ª•c selection c≈© sau khi Play Again
function restoreSelection(level, unit) {
    const levelSelect = document.getElementById('levelSelect');
    const unitSelect = document.getElementById('unitSelect');
    const loadBtn = document.querySelector('.load-vocab-btn');
    const startBtn = document.getElementById('startGameBtn');
    
    // Ki·ªÉm tra vocabularyStructure ƒë√£ ƒë∆∞·ª£c load ch∆∞a
    if (!vocabularyStructure || Object.keys(vocabularyStructure).length === 0) {
        console.log('Vocabulary structure not loaded yet, retrying...');
        setTimeout(() => restoreSelection(level, unit), 500);
        return;
    }
    
    // Ch·ªçn Level
    if (levelSelect) {
        levelSelect.value = level;
        
        if (levelSelect.value) {
            // K√≠ch ho·∫°t s·ª± ki·ªán change
            const changeEvent = new Event('change');
            levelSelect.dispatchEvent(changeEvent);
            
            setTimeout(() => {
                // Ch·ªçn Unit
                if (unitSelect) {
                    unitSelect.value = unit;
                    
                    if (unitSelect.value && loadBtn) {
                        loadBtn.disabled = false;
                        
                        // ƒê·∫£m b·∫£o vocabularyStructure[level] t·ªìn t·∫°i
                        if (vocabularyStructure[level] && vocabularyStructure[level][unit]) {
                            // Load t·ª´ v·ª±ng
                            loadVocabularyFromStructure(level, unit);
                            
                            // Hi·ªÉn th·ªã th√¥ng b√°o
                            document.getElementById('vocabPreview').style.display = 'block';
                            document.getElementById('vocabPreview').textContent = 
                                `‚úÖ Previous selection restored: ${level} - ${unit}`;
                        }
                    }
                }
            }, 300);
        }
    }
}

// H√†m m·ªõi: Load t·ª´ v·ª±ng t·ª´ structure
function loadVocabularyFromStructure(level, unit) {
    selectedLevel = level;
    selectedUnit = unit;
    
    const vocabList = vocabularyStructure[level][unit];
    if (!vocabList || vocabList.length === 0) {
        console.error('No vocabulary found for', level, unit);
        return;
    }
    
    // Parse t·ª´ v·ª±ng
    words = [];
    for (let line of vocabList) {
        const parts = line.split('|').map(s => s.trim());
        if (parts.length >= 2 && parts[0] && parts[1]) {
            words.push({
                word: parts[0].toLowerCase(),
                hint: parts[1]
            });
        }
    }
    
    console.log(`Loaded ${words.length} words from ${level} - ${unit}`);
    
    // Enable start game button
    const startBtn = document.getElementById('startGameBtn');
    if (startBtn && words.length > 0) {
        startBtn.disabled = false;
    }
}
    </script>
</body>
</html>
