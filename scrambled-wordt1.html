<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letter Grid Collector - Super Minds</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5deb3 0%, #fffacd 50%, #faebd7 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #logoContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            animation: logoShake 3s ease-in-out infinite;
        }

        #gameLogo {
            width: 120px;
            height: auto;
            border-radius: 15px;
            /*box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);*/
            transition: transform 0.3s;
        }

        #gameLogo:hover {
            transform: scale(1.1);
        }

        @keyframes logoShake {
            0%, 100% { 
                transform: rotate(-5deg) translateY(0px); 
            }
            25% { 
                transform: rotate(5deg) translateY(-5px); 
            }
            50% { 
                transform: rotate(-5deg) translateY(5px); 
            }
            75% { 
                transform: rotate(5deg) translateY(-5px); 
            }
        }

        @media (max-width: 768px) {
            #gameLogo {
                width: 80px;
            }
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .mode-section {
            margin-bottom: 30px;
        }

        .mode-section h2 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 1.5em;
            text-align: center;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 20px 40px;
            font-size: 20px;
            font-weight: bold;
            border: 3px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #555;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .mode-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .mode-btn.practice {
            border-color: #27ae60;
        }

        .mode-btn.practice.selected {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .mode-btn.highscore {
            border-color: #f39c12;
        }

        .mode-btn.highscore.selected {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .mode-info {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 14px;
            color: #555;
            text-align: center;
        }

        .setup-section {
            display: none;
            margin-bottom: 30px;
        }

        .setup-section h2 {
            color: #764ba2;
            margin-bottom: 15px;
            font-size: 1.5em;
            text-align: center;
        }

        .selection-row {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .select-group {
            flex: 1;
            min-width: 200px;
        }

        .select-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 3px solid #667eea;
            border-radius: 10px;
            background: white;
            cursor: pointer;
        }

        .btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-container {
            text-align: center;
            margin-top: 20px;
        }

        .game-section {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .game-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .score-display {
            font-size: 24px;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .combo-display {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .progress-section {
            margin-bottom: 20px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .grid-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }

        .grid-board {
            display: grid;
            grid-template-columns: repeat(10, 50px);
            grid-template-rows: repeat(10, 50px);
            gap: 3px;
            background: #34495e;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .grid-cell {
            width: 50px;
            height: 50px;
            background: #ecf0f1;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .grid-cell:hover {
            background: #d5dbdb;
            transform: scale(1.1);
        }

        .grid-cell.has-letter {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            animation: fadeIn 0.3s ease;
        }

        .grid-cell.selected {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            border-color: #d35400;
            transform: scale(1.15);
        }

        .grid-cell.correct {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            animation: correctAnim 0.5s ease;
        }

        .grid-cell.hint {
            border: 4px solid gold !important;
            box-shadow: 0 0 25px gold !important;
            animation: hintPulse 1.5s infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes correctAnim {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(10deg); }
        }

        @keyframes hintPulse {
            0%, 100% { 
                box-shadow: 0 0 25px gold;
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px gold, 0 0 50px gold;
                transform: scale(1.05);
            }
        }

        .word-display {
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .word-label {
            font-size: 16px;
            color: #555;
            margin-bottom: 10px;
        }

        .word-letters {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 5px;
            font-family: monospace;
            min-height: 50px;
        }

        .word-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .clear-btn {
            padding: 10px 25px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .check-btn {
            padding: 10px 25px;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
        }

        .check-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .check-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-btn {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .pause-btn {
            background: #3498db;
        }

        .hint-btn {
            background: #9b59b6;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .feedback {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin: 15px 0;
            min-height: 60px;
            animation: fadeIn 0.3s ease;
            padding: 10px;
            border-radius: 8px;
        }

        .feedback.correct {
            color: #27ae60;
            background: #d5f4e6;
        }

        .feedback.wrong {
            color: #e74c3c;
            background: #fadbd8;
        }

        .feedback.hint {
            color: #f39c12;
            background: #fef5e7;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #667eea;
        }

        .modal-stats {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .modal-stats div {
            margin: 10px 0;
            font-size: 18px;
            color: #555;
        }

        .word-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            text-align: left;
        }

        .word-list h3 {
            color: #764ba2;
            margin-bottom: 10px;
        }

        .word-list-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .word-item {
            padding: 5px 10px;
            background: white;
            border-radius: 5px;
            font-weight: bold;
            border: 2px solid #ddd;
        }

        .word-item.completed {
            border-color: #27ae60;
            color: #27ae60;
        }

        .word-item.incomplete {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .word-item.bonus {
            border-color: #f39c12;
            color: #f39c12;
            background: #fff9e6;
        }

        .bonus-words-section {
            margin: 15px 0;
            padding: 15px;
            background: #fff9e6;
            border-radius: 8px;
            border: 2px solid #f39c12;
        }

        .bonus-words-section h3 {
            color: #f39c12;
            margin-bottom: 10px;
        }

        .leaderboard {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .leaderboard h3 {
            color: #764ba2;
            margin-bottom: 15px;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            border-left: 5px solid #667eea;
        }

        .leaderboard-entry.top1 {
            border-left-color: #f39c12;
            background: #fff9e6;
        }

        .leaderboard-entry.top2 {
            border-left-color: #95a5a6;
        }

        .leaderboard-entry.top3 {
            border-left-color: #cd7f32;
        }

        .music-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .music-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .music-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .music-btn.muted {
            background: #95a5a6;
        }

        .end-game-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
        }

        .end-game-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .pause-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .pause-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
        }

        .pause-content h2 {
            color: #3498db;
            font-size: 48px;
            margin-bottom: 20px;
        }

        .vocab-status {
            background: #e8f5e9;
            border: 2px solid #27ae60;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            color: #27ae60;
            font-weight: bold;
            text-align: center;
        }

        .vocab-status.error {
            background: #ffebee;
            border-color: #e74c3c;
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .grid-board {
                grid-template-columns: repeat(8, 40px);
                grid-template-rows: repeat(8, 40px);
            }
            
            .grid-cell {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .mode-btn {
                padding: 15px 25px;
                font-size: 16px;
            }
            
            .music-btn {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            
            .end-game-btn {
                width: 55px;
                height: 55px;
                font-size: 12px;
                bottom: 15px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="logoContainer">
        <img src="logo.png" alt="Super Minds Logo" id="gameLogo">
    </div>

    <div class="music-control">
        <button id="musicToggle" class="music-btn" onclick="toggleMusic()">‚ô´</button>
    </div>

    <button id="endGameBtn" class="end-game-btn" onclick="endGameEarly()" style="display: none;">K·∫æT TH√öC</button>

    <div class="container">
        <h1>üéØ Letter Grid Collector üéØ</h1>

        <div id="modeSection" class="mode-section">
            <div id="vocabStatus" class="vocab-status" style="display: none;"></div>
            
            <h2>üìö Ch·ªçn Ch·∫ø ƒê·ªô Ch∆°i</h2>
            <div class="mode-selector">
                <button class="mode-btn practice selected" onclick="selectMode('practice')">
                    üìù Tr·∫£ B√†i
                </button>
                <button class="mode-btn highscore" onclick="selectMode('highscore')">
                    üèÜ Thi ƒêua ƒêi·ªÉm Cao
                </button>
            </div>
            <div id="modeInfo" class="mode-info">
                <strong>TR·∫¢ B√ÄI:</strong> Ho√†n th√†nh t·∫•t c·∫£ t·ª´ v·ª±ng trong Level v√† Unit ƒë√£ ch·ªçn üìñ
            </div>
        </div>

        <div id="setupSection" class="setup-section">
            <h2>‚öôÔ∏è C√†i ƒê·∫∑t Game</h2>
            
            <div class="selection-row">
                <div class="select-group">
                    <label for="levelSelect">üìö Ch·ªçn Level:</label>
                    <select id="levelSelect" onchange="onLevelChange()">
                        <option value="">-- Ch·ªçn Level --</option>
                        <option value="0">Super Minds 0</option>
                        <option value="1">Super Minds 1</option>
                        <option value="2">Super Minds 2</option>
                        <option value="3">Super Minds 3</option>
                        <option value="4">Super Minds 4</option>
                        <option value="5">Super Minds 5</option>
                        <option value="6">Super Minds 6</option>
                    </select>
                </div>
                <div class="select-group">
                    <label for="unitSelect">üìñ Ch·ªçn Unit:</label>
                    <select id="unitSelect" disabled onchange="onUnitChange()">
                        <option value="">-- Ch·ªçn Unit --</option>
                    </select>
                </div>
            </div>
            <div class="btn-container">
                <button id="startBtn" class="btn btn-success" onclick="startGame()" disabled>
                    üéÆ B·∫Øt ƒê·∫ßu Ch∆°i
                </button>
            </div>
        </div>

        <div id="gameSection" class="game-section">
            <div class="game-header">
                <div class="game-info">
                    <div class="info-box score-display">
                        üí∞ ƒêi·ªÉm: <span id="score">0</span>
                    </div>
                    <div id="comboDisplay" class="info-box combo-display" style="display: none;">
                        üî• Combo: x<span id="combo">1</span>
                    </div>
                    <div class="info-box">
                        ‚è±Ô∏è T·ªëc ƒë·ªô: <span id="speedLevel">1</span>
                    </div>
                    <div class="info-box" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                        üìö T·ª´ m·ªü r·ªông: <span id="bonusCount">0</span>
                    </div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-label">
                    <span>üìä Ti·∫øn ƒê·ªô</span>
                    <span id="progressText">0 / 0</span>
                </div>
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar" style="width: 0%;">0%</div>
                </div>
            </div>

            <div class="grid-container">
                <div id="gridBoard" class="grid-board"></div>
            </div>

            <div class="word-display">
                <div class="word-label">T·ª´ b·∫°n ƒëang gh√©p:</div>
                <div id="currentWord" class="word-letters">___</div>
                <div class="word-actions">
                    <button class="clear-btn" onclick="clearSelection()">üóëÔ∏è X√≥a</button>
                    <button id="checkBtn" class="check-btn" onclick="checkWord()" disabled>‚úÖ Check</button>
                    <button id="pauseBtn" class="control-btn pause-btn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
                    <button id="hintBtn" class="control-btn hint-btn" onclick="useHint()">üí° Hint (<span id="hintCount">3</span>)</button>
                </div>
            </div>

            <div id="feedback" class="feedback"></div>
        </div>

        <div id="gameOverModal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle">üéâ K·∫øt Qu·∫£ üéâ</h2>
                <div class="modal-stats">
                    <div id="finalScore"><strong>T·ªïng ƒêi·ªÉm:</strong> 0</div>
                    <div id="modeDisplay"></div>
                    <div id="completionStats"></div>
                </div>
                <div id="bonusWordsSection" class="bonus-words-section" style="display: none;">
                    <h3>‚≠ê T·ª´ M·ªü R·ªông ƒê√£ T√¨m ƒê∆∞·ª£c</h3>
                    <div class="word-list-items" id="bonusWordsList"></div>
                </div>
                <div id="wordListSection" class="word-list" style="display: none;">
                    <h3>Danh S√°ch T·ª´ V·ª±ng B√†i H·ªçc</h3>
                    <div class="word-list-items" id="wordListItems"></div>
                </div>
                <div id="leaderboardSection" class="leaderboard" style="display: none;">
                    <h3>üèÜ B·∫£ng X·∫øp H·∫°ng Top 5</h3>
                    <div id="leaderboardList"></div>
                </div>
                <div class="btn-container">
                    <button class="btn btn-primary" onclick="playAgain()">üîÑ Ch∆°i L·∫°i</button>
                </div>
            </div>
        </div>

        <div id="pauseOverlay" class="pause-overlay">
            <div class="pause-content">
                <h2>‚è∏Ô∏è PAUSED</h2>
                <p>Nh·∫•n Resume ƒë·ªÉ ti·∫øp t·ª•c</p>
                <button class="btn btn-primary" onclick="togglePause()">‚ñ∂Ô∏è Resume</button>
            </div>
        </div>
    </div>

    <script>
        const backgroundMusic = new Audio('background-music.mp3');
        backgroundMusic.loop = true;
        backgroundMusic.volume = 0.5;

        const correctSound = new Audio('right.mp3');
        const wrongSound = new Audio('drop.mp3');
        const comboSound = new Audio('drop.mp3');

        let isMusicPlaying = false;
        let musicInitialized = false;

        let vocabData = {};
        let expansionVocab = [];
        let allVocabWords = [];
        let vocabLoaded = false;

        function loadVocabFile(fileContent) {
            vocabData = {};
            expansionVocab = [];
            const lines = fileContent.split('\n');
            let currentLevel = null;
            let currentUnit = null;
            let isExpansion = false;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                if (line.match(/===\s*Expansion\s*===/i)) {
                    isExpansion = true;
                    currentLevel = null;
                    currentUnit = null;
                    return;
                }

                const levelMatch = line.match(/===\s*Super Minds\s+(\d+)\s*===/);
                if (levelMatch) {
                    isExpansion = false;
                    currentLevel = levelMatch[1];
                    vocabData[currentLevel] = {};
                    return;
                }

                const unitMatch = line.match(/\[Unit\s+(\d+)\]/);
                if (unitMatch) {
                    currentUnit = unitMatch[1];
                    if (currentLevel !== null && !isExpansion) {
                        vocabData[currentLevel][currentUnit] = [];
                    }
                    return;
                }

                if (isExpansion && line.length > 0) {
                    expansionVocab.push(line.toLowerCase());
                } else if (currentLevel !== null && currentUnit !== null && line.length > 0) {
                    vocabData[currentLevel][currentUnit].push(line.toLowerCase());
                }
            });

            buildAllVocabList();
            populateLevelSelect();
            vocabLoaded = true;
            showVocabStatus(true);
            console.log('Vocabulary loaded:', vocabData);
            console.log('Expansion vocab:', expansionVocab);
        }

        function buildAllVocabList() {
            allVocabWords = [];
            Object.values(vocabData).forEach(level => {
                Object.values(level).forEach(unitWords => {
                    allVocabWords.push(...unitWords);
                });
            });
            allVocabWords.push(...expansionVocab);
        }

        function populateLevelSelect() {
            const levelSelect = document.getElementById('levelSelect');
            levelSelect.innerHTML = '<option value="">-- Ch·ªçn Level --</option>';
            
            Object.keys(vocabData).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
                const option = document.createElement('option');
                option.value = level;
                option.textContent = `Super Minds ${level}`;
                levelSelect.appendChild(option);
            });
        }

        function showVocabStatus(success) {
            const statusEl = document.getElementById('vocabStatus');
            statusEl.style.display = 'block';
            
            if (success) {
                statusEl.className = 'vocab-status';
                const totalWords = allVocabWords.length;
                const levels = Object.keys(vocabData).length;
                statusEl.textContent = `‚úÖ ƒê√£ t·∫£i ${totalWords} t·ª´ v·ª±ng t·ª´ ${levels} levels + ${expansionVocab.length} t·ª´ m·ªü r·ªông`;
            } else {
                statusEl.className = 'vocab-status error';
                statusEl.textContent = '‚ùå Kh√¥ng t√¨m th·∫•y file vocab.txt! H√£y ƒë·∫∑t file vocab.txt c√πng th∆∞ m·ª•c v·ªõi file HTML n√†y.';
            }
        }

        window.onload = function() {
            fetch('vocab.txt')
                .then(response => {
                    if (!response.ok) throw new Error('File not found');
                    return response.text();
                })
                .then(text => {
                    loadVocabFile(text);
                    console.log('Vocabulary file loaded successfully!');
                })
                .catch(err => {
                    console.error('Failed to load vocab.txt:', err);
                    showVocabStatus(false);
                    vocabLoaded = false;
                });
            
            document.getElementById('modeSection').style.display = 'block';
        };


        let gameMode = 'practice';
        let selectedLevel = '';
        let selectedUnit = '';
        let targetWords = [];
        let completedWords = [];
        let bonusWords = [];
        let currentScore = 0;
        let currentCombo = 0;
        let speedLevel = 1;
        let hintsRemaining = 3;
        let isPaused = false;
        let isGameOver = false;
        let hintCellIndex = -1;

        const gridSize = 10;
        let gridCells = [];
        let selectedCells = [];
        let letterSpawnInterval = null;
        let spawnDelay = 10000;
        let currentWordForSpawn = null;
        let lettersToSpawn = [];

        function initializeGrid() {
            const gridBoard = document.getElementById('gridBoard');
            gridBoard.innerHTML = '';
            gridCells = [];
            
            const isMobile = window.innerWidth <= 768;
            const actualSize = isMobile ? 8 : gridSize;
            gridBoard.style.gridTemplateColumns = `repeat(${actualSize}, ${isMobile ? 40 : 50}px)`;
            gridBoard.style.gridTemplateRows = `repeat(${actualSize}, ${isMobile ? 40 : 50}px)`;
            
            for (let i = 0; i < actualSize * actualSize; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.index = i;
                cell.onclick = () => selectCell(i);
                gridBoard.appendChild(cell);
                gridCells.push({
                    element: cell,
                    letter: '',
                    hasLetter: false
                });
            }
        }

        function selectMode(mode) {
            if (!vocabLoaded) {
                alert('‚ö†Ô∏è Ch∆∞a t·∫£i ƒë∆∞·ª£c file vocab.txt! H√£y ƒë·∫£m b·∫£o file vocab.txt n·∫±m c√πng th∆∞ m·ª•c v·ªõi file HTML.');
                return;
            }
            
            gameMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('selected'));
            
            if (mode === 'practice') {
                document.querySelector('.mode-btn.practice').classList.add('selected');
                document.getElementById('modeInfo').innerHTML = '<strong>TR·∫¢ B√ÄI:</strong> Ho√†n th√†nh t·∫•t c·∫£ t·ª´ v·ª±ng trong Level v√† Unit ƒë√£ ch·ªçn üìñ';
            } else {
                document.querySelector('.mode-btn.highscore').classList.add('selected');
                document.getElementById('modeInfo').innerHTML = '<strong>THI ƒêUA ƒêI·ªÇM CAO:</strong> Ho√†n th√†nh t·ª´ v·ª±ng t·ª´ Level th·∫•p ƒë·∫øn Level b·∫°n ƒë√£ h·ªçc üèÜ';
            }
            
            document.getElementById('setupSection').style.display = 'block';
        }

        function onLevelChange() {
            const levelSelect = document.getElementById('levelSelect');
            const unitSelect = document.getElementById('unitSelect');
            selectedLevel = levelSelect.value;
            
            if (selectedLevel) {
                unitSelect.disabled = false;
                unitSelect.innerHTML = '<option value="">-- Ch·ªçn Unit --</option>';
                
                if (vocabData[selectedLevel]) {
                    Object.keys(vocabData[selectedLevel]).forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit;
                        option.textContent = `Unit ${unit}`;
                        unitSelect.appendChild(option);
                    });
                }
            } else {
                unitSelect.disabled = true;
                unitSelect.innerHTML = '<option value="">-- Ch·ªçn Unit --</option>';
                document.getElementById('startBtn').disabled = true;
            }
        }

        function onUnitChange() {
            selectedUnit = document.getElementById('unitSelect').value;
            document.getElementById('startBtn').disabled = !selectedUnit;
        }

        function startGame() {
            if (!vocabLoaded) {
                alert('‚ö†Ô∏è Ch∆∞a t·∫£i ƒë∆∞·ª£c file vocab.txt!');
                return;
            }
            
            initializeMusic();
            
            targetWords = [];
            
            if (gameMode === 'practice') {
                if (vocabData[selectedLevel] && vocabData[selectedLevel][selectedUnit]) {
                    targetWords = [...vocabData[selectedLevel][selectedUnit]];
                }
            } else {
                for (let level = 0; level <= parseInt(selectedLevel); level++) {
                    if (vocabData[level.toString()]) {
                        Object.values(vocabData[level.toString()]).forEach(unitWords => {
                            targetWords.push(...unitWords);
                        });
                    }
                }
            }
            
            if (targetWords.length === 0) {
                alert('Kh√¥ng c√≥ t·ª´ v·ª±ng n√†o trong Level/Unit n√†y!');
                return;
            }
            
            targetWords.sort(() => Math.random() - 0.5);
            
            completedWords = [];
            bonusWords = [];
            currentScore = 0;
            currentCombo = 0;
            speedLevel = 1;
            hintsRemaining = 3;
            isPaused = false;
            isGameOver = false;
            selectedCells = [];
            hintCellIndex = -1;
            currentWordForSpawn = null;
            lettersToSpawn = [];
            
            document.getElementById('score').textContent = currentScore;
            document.getElementById('combo').textContent = currentCombo;
            document.getElementById('speedLevel').textContent = speedLevel;
            document.getElementById('hintCount').textContent = hintsRemaining;
            document.getElementById('bonusCount').textContent = '0';
            document.getElementById('comboDisplay').style.display = 'none';
            document.getElementById('progressText').textContent = `0 / ${targetWords.length}`;
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            document.getElementById('currentWord').textContent = '___';
            document.getElementById('feedback').textContent = '';
            document.getElementById('checkBtn').disabled = true;
            
            document.getElementById('modeSection').style.display = 'none';
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
            document.getElementById('endGameBtn').style.display = 'block';
            
            initializeGrid();
            prepareNextWord();
            spawnInitialLetters();
            startLetterSpawning();
        }

        function prepareNextWord() {
            const availableWords = targetWords.filter(word => !completedWords.includes(word));
            if (availableWords.length === 0) {
                currentWordForSpawn = null;
                lettersToSpawn = [];
                return;
            }
            
            currentWordForSpawn = availableWords[Math.floor(Math.random() * availableWords.length)];
            lettersToSpawn = currentWordForSpawn.split('').map(l => l.toUpperCase());
            lettersToSpawn.sort(() => Math.random() - 0.5);
        }

        function spawnInitialLetters() {
            const firstWords = targetWords.slice(0, 2);
            const letters = [];
            firstWords.forEach(word => {
                word.split('').forEach(letter => {
                    letters.push(letter.toUpperCase());
                });
            });
            
            letters.sort(() => Math.random() - 0.5);
            
            letters.forEach(letter => {
                const emptyCells = gridCells.filter(cell => !cell.hasLetter);
                if (emptyCells.length === 0) return;
                
                const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                randomCell.letter = letter;
                randomCell.hasLetter = true;
                randomCell.element.textContent = letter;
                randomCell.element.classList.add('has-letter');
            });
        }

        function startLetterSpawning() {
            letterSpawnInterval = setInterval(() => {
                if (!isPaused && !isGameOver) {
                    spawnLetter();
                }
            }, spawnDelay);
        }

        function spawnLetter() {
            if (isGameOver) return;
            
            if (lettersToSpawn.length === 0) {
                prepareNextWord();
                if (!currentWordForSpawn) {
                    endGame(true);
                    return;
                }
            }
            
            const letterToSpawn = lettersToSpawn.shift();
            
            const emptyCells = gridCells.filter(cell => !cell.hasLetter);
            if (emptyCells.length === 0) {
                endGame(false);
                return;
            }
            
            const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
            randomCell.letter = letterToSpawn;
            randomCell.hasLetter = true;
            randomCell.element.textContent = letterToSpawn;
            randomCell.element.classList.add('has-letter');
        }

        function selectCell(index) {
            if (isPaused || isGameOver) return;
            
            const cell = gridCells[index];
            if (!cell.hasLetter) return;
            
            if (index === hintCellIndex) {
                cell.element.classList.remove('hint');
                hintCellIndex = -1;
            }
            
            const selectedIndex = selectedCells.indexOf(index);
            if (selectedIndex !== -1) {
                selectedCells.splice(selectedIndex, 1);
                cell.element.classList.remove('selected');
            } else {
                selectedCells.push(index);
                cell.element.classList.add('selected');
            }
            
            updateCurrentWord();
        }

        function updateCurrentWord() {
            const word = selectedCells.map(i => gridCells[i].letter).join('');
            document.getElementById('currentWord').textContent = word || '___';
            document.getElementById('checkBtn').disabled = word.length === 0;
        }

        function checkWord() {
            if (selectedCells.length === 0) return;
            
            const currentWord = selectedCells.map(i => gridCells[i].letter).join('').toLowerCase();
            
            // 1. Ki·ªÉm tra trong targetWords (t·ª´ v·ª±ng b√†i h·ªçc)
            const matchingWord = targetWords.find(word => 
                word === currentWord && !completedWords.includes(word)
            );
            
            if (matchingWord) {
                correctWord(matchingWord, false);
                return;
            }
            
            // 2. Ki·ªÉm tra trong t·ª´ v·ª±ng m·ªü r·ªông (expansionVocab)
            const expansionMatch = expansionVocab.find(word => 
                word === currentWord && !bonusWords.includes(word)
            );
            
            if (expansionMatch) {
                correctWord(expansionMatch, true);
                return;
            }
            
            // 3. Ki·ªÉm tra trong to√†n b·ªô th∆∞ vi·ªán t·ª´ v·ª±ng (allVocabWords)
            const allVocabMatch = allVocabWords.find(word => 
                word === currentWord && !completedWords.includes(word) && !bonusWords.includes(word)
            );
            
            if (allVocabMatch) {
                // Ki·ªÉm tra xem t·ª´ n√†y c√≥ thu·ªôc expansion kh√¥ng
                const isExpansionWord = expansionVocab.includes(allVocabMatch);
                correctWord(allVocabMatch, isExpansionWord);
                return;
            }
            
            // 4. N·∫øu kh√¥ng t√¨m th·∫•y trong b·∫•t k·ª≥ danh s√°ch n√†o
            wrongWord();
        }

        function correctWord(word, isBonus) {
            correctSound.play().catch(e => console.log('Audio play failed:', e));
            
            currentCombo++;
            let comboBonus = 0;
            if (currentCombo >= 2) {
                comboBonus = (currentCombo - 1) * 10;
                document.getElementById('comboDisplay').style.display = 'block';
                document.getElementById('combo').textContent = currentCombo;
                
                if (currentCombo >= 3) {
                    comboSound.play().catch(e => console.log('Audio play failed:', e));
                }
            }
            
            const baseScore = word.length * 10;
            const bonusMultiplier = isBonus ? 1.5 : 1;
            const totalScore = Math.floor((baseScore + comboBonus) * bonusMultiplier);
            currentScore += totalScore;
            document.getElementById('score').textContent = currentScore;
            
            if (isBonus) {
                // Th√™m v√†o bonusWords n·∫øu ch∆∞a c√≥
                if (!bonusWords.includes(word)) {
                    bonusWords.push(word);
                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã s·ªë l∆∞·ª£ng t·ª´ m·ªü r·ªông
                    document.getElementById('bonusCount').textContent = bonusWords.length;
                }
            } else {
                // Th√™m v√†o completedWords n·∫øu ch∆∞a c√≥
                if (!completedWords.includes(word)) {
                    completedWords.push(word);
                    updateProgress();
                }
            }
            
            const feedbackEl = document.getElementById('feedback');
            feedbackEl.className = 'feedback correct';
            if (isBonus) {
                feedbackEl.textContent = `‚≠ê T·ª™ M·ªû R·ªòNG: ${word.toUpperCase()} (+${totalScore} ƒëi·ªÉm x1.5!)`;
            } else {
                feedbackEl.textContent = `‚úÖ ${word.toUpperCase()} (+${totalScore} ƒëi·ªÉm)`;
            }
            setTimeout(() => {
                feedbackEl.textContent = '';
                feedbackEl.className = 'feedback';
            }, 2000);
            
            selectedCells.forEach(index => {
                const cell = gridCells[index];
                cell.element.classList.add('correct');
                setTimeout(() => {
                    cell.element.classList.remove('correct', 'has-letter', 'selected');
                    cell.element.textContent = '';
                    cell.hasLetter = false;
                    cell.letter = '';
                }, 500);
            });
            
            selectedCells = [];
            updateCurrentWord();
            
            if (completedWords.length % 5 === 0) {
                increaseSpeed();
            }
            
            // Ki·ªÉm tra xem ƒë√£ ho√†n th√†nh t·∫•t c·∫£ targetWords ch∆∞a
            const allTargetWordsCompleted = targetWords.every(word => 
                completedWords.includes(word)
            );
            
            if (allTargetWordsCompleted) {
                endGame(true);
            }
        }

        function wrongWord() {
            wrongSound.play().catch(e => console.log('Audio play failed:', e));
            
            currentCombo = 0;
            document.getElementById('comboDisplay').style.display = 'none';
            
            const feedbackEl = document.getElementById('feedback');
            feedbackEl.className = 'feedback wrong';
            feedbackEl.textContent = '‚ùå Sai r·ªìi! Th·ª≠ l·∫°i nh√©!';
            setTimeout(() => {
                feedbackEl.textContent = '';
                feedbackEl.className = 'feedback';
            }, 2000);
            
            clearSelection();
        }

        function clearSelection() {
            selectedCells.forEach(index => {
                gridCells[index].element.classList.remove('selected');
            });
            selectedCells = [];
            updateCurrentWord();
        }

        function useHint() {
            if (hintsRemaining <= 0 || isPaused || isGameOver) return;
            
            if (hintCellIndex !== -1) {
                gridCells[hintCellIndex].element.classList.remove('hint');
            }
            
            const availableWords = targetWords.filter(word => !completedWords.includes(word));
            if (availableWords.length === 0) return;
            
            const randomWord = availableWords[Math.floor(Math.random() * availableWords.length)];
            const hintLetter = randomWord[0].toUpperCase();
            
            const hintCells = gridCells
                .map((cell, index) => ({ cell, index }))
                .filter(({ cell, index }) => 
                    cell.hasLetter && 
                    cell.letter === hintLetter && 
                    !selectedCells.includes(index)
                );
            
            if (hintCells.length > 0) {
                const randomHint = hintCells[Math.floor(Math.random() * hintCells.length)];
                hintCellIndex = randomHint.index;
                randomHint.cell.element.classList.add('hint');
                
                hintsRemaining--;
                document.getElementById('hintCount').textContent = hintsRemaining;
                
                const feedbackEl = document.getElementById('feedback');
                feedbackEl.className = 'feedback hint';
                feedbackEl.textContent = `üí° G·ª£i √Ω: Ch·ªØ "${hintLetter}" ƒë·ªÉ b·∫Øt ƒë·∫ßu t·ª´ "${randomWord}"!`;
            } else {
                const feedbackEl = document.getElementById('feedback');
                feedbackEl.className = 'feedback wrong';
                feedbackEl.textContent = '‚ùå Kh√¥ng t√¨m th·∫•y ch·ªØ c√°i ƒë·ªÉ g·ª£i √Ω!';
                setTimeout(() => {
                    feedbackEl.textContent = '';
                    feedbackEl.className = 'feedback';
                }, 2000);
            }
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseOverlay').style.display = isPaused ? 'flex' : 'none';
            document.getElementById('pauseBtn').textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
        }

        function endGameEarly() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën k·∫øt th√∫c game s·ªõm? ƒêi·ªÉm s·ªë hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c l∆∞u l·∫°i.')) {
                endGame(false);
            }
        }

        function increaseSpeed() {
            speedLevel++;
            document.getElementById('speedLevel').textContent = speedLevel;
            
            spawnDelay = Math.max(3000, 10000 - (speedLevel * 1000));
            
            clearInterval(letterSpawnInterval);
            letterSpawnInterval = setInterval(() => {
                if (!isPaused && !isGameOver) {
                    spawnLetter();
                }
            }, spawnDelay);
        }

        function updateProgress() {
            const progress = (completedWords.length / targetWords.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressBar').textContent = Math.round(progress) + '%';
            document.getElementById('progressText').textContent = `${completedWords.length} / ${targetWords.length}`;
        }

        function endGame(completed) {
            isGameOver = true;
            clearInterval(letterSpawnInterval);
            document.getElementById('endGameBtn').style.display = 'none';
            
            const modal = document.getElementById('gameOverModal');
            const modalTitle = document.getElementById('modalTitle');
            const finalScore = document.getElementById('finalScore');
            const modeDisplay = document.getElementById('modeDisplay');
            const completionStats = document.getElementById('completionStats');
            const wordListSection = document.getElementById('wordListSection');
            const wordListItems = document.getElementById('wordListItems');
            const bonusWordsSection = document.getElementById('bonusWordsSection');
            const bonusWordsList = document.getElementById('bonusWordsList');
            
            if (completed) {
                modalTitle.textContent = 'üéâ Ch√∫c M·ª´ng! üéâ';
                modalTitle.style.color = '#27ae60';
            } else {
                modalTitle.textContent = 'üèÅ K·∫øt Th√∫c';
                modalTitle.style.color = '#3498db';
            }
            
            finalScore.innerHTML = `<strong>T·ªïng ƒêi·ªÉm:</strong> ${currentScore} üí∞`;
            
            if (gameMode === 'practice') {
                modeDisplay.innerHTML = `<strong>Ch·∫ø ƒê·ªô:</strong> Tr·∫£ B√†i<br><strong>Level:</strong> Super Minds ${selectedLevel} | <strong>Unit:</strong> ${selectedUnit}`;
            } else {
                modeDisplay.innerHTML = `<strong>Ch·∫ø ƒê·ªô:</strong> Thi ƒêua ƒêi·ªÉm Cao<br><strong>Level ƒê√£ H·ªçc:</strong> Super Minds ${selectedLevel}`;
            }
            
            completionStats.innerHTML = `<strong>Ho√†n Th√†nh:</strong> ${completedWords.length} / ${targetWords.length} t·ª´ (${Math.round((completedWords.length / targetWords.length) * 100)}%)`;
            
            if (bonusWords.length > 0) {
                bonusWordsSection.style.display = 'block';
                bonusWordsList.innerHTML = '';
                bonusWords.forEach(word => {
                    const wordItem = document.createElement('div');
                    wordItem.className = 'word-item bonus';
                    wordItem.textContent = word;
                    bonusWordsList.appendChild(wordItem);
                });
                
                // Th√™m th√¥ng b√°o ƒë·∫∑c bi·ªát v·ªÅ t·ª´ m·ªü r·ªông
                const bonusMessage = document.createElement('div');
                bonusMessage.style.marginTop = '10px';
                bonusMessage.style.padding = '10px';
                bonusMessage.style.backgroundColor = '#fff9e6';
                bonusMessage.style.borderRadius = '8px';
                bonusMessage.style.fontSize = '14px';
                bonusMessage.innerHTML = `üéâ B·∫°n ƒë√£ t√¨m th·∫•y <strong>${bonusWords.length}</strong> t·ª´ m·ªü r·ªông!`;
                bonusWordsSection.appendChild(bonusMessage);
            } else {
                bonusWordsSection.style.display = 'none';
            }
            
            wordListSection.style.display = 'block';
            wordListItems.innerHTML = '';
            targetWords.forEach(word => {
                const wordItem = document.createElement('div');
                wordItem.className = completedWords.includes(word) ? 'word-item completed' : 'word-item incomplete';
                wordItem.textContent = word;
                wordListItems.appendChild(wordItem);
            });
            
            if (gameMode === 'highscore') {
                saveScore();
                showLeaderboard();
            } else {
                document.getElementById('leaderboardSection').style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        function saveScore() {
            const leaderboard = JSON.parse(localStorage.getItem('letterGridLeaderboard') || '[]');
            
            const entry = {
                score: currentScore,
                level: selectedLevel,
                words: completedWords.length,
                bonus: bonusWords.length,
                date: new Date().toLocaleDateString('vi-VN')
            };
            
            leaderboard.push(entry);
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard.splice(5);
            
            localStorage.setItem('letterGridLeaderboard', JSON.stringify(leaderboard));
        }

        function showLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('letterGridLeaderboard') || '[]');
            const leaderboardSection = document.getElementById('leaderboardSection');
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (leaderboard.length === 0) {
                leaderboardSection.style.display = 'none';
                return;
            }
            
            leaderboardSection.style.display = 'block';
            leaderboardList.innerHTML = '';
            
            leaderboard.forEach((entry, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'leaderboard-entry';
                if (index === 0) entryDiv.classList.add('top1');
                else if (index === 1) entryDiv.classList.add('top2');
                else if (index === 2) entryDiv.classList.add('top3');
                
                const rank = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`;
                
                entryDiv.innerHTML = `
                    <div><strong>${rank}</strong> Level ${entry.level} - ${entry.words} t·ª´${entry.bonus ? ' (+' + entry.bonus + ' bonus)' : ''}</div>
                    <div><strong>${entry.score}</strong> ƒëi·ªÉm</div>
                `;
                leaderboardList.appendChild(entryDiv);
            });
        }

        function playAgain() {
            document.getElementById('gameOverModal').style.display = 'none';
            document.getElementById('gameSection').style.display = 'none';
            document.getElementById('endGameBtn').style.display = 'none';
            document.getElementById('modeSection').style.display = 'block';
            document.getElementById('setupSection').style.display = 'none';
            
            document.getElementById('levelSelect').value = '';
            document.getElementById('unitSelect').value = '';
            document.getElementById('unitSelect').disabled = true;
            document.getElementById('startBtn').disabled = true;
            
            selectedLevel = '';
            selectedUnit = '';
        }

        function initializeMusic() {
            if (!musicInitialized) {
                const playMusic = () => {
                    backgroundMusic.play().then(() => {
                        isMusicPlaying = true;
                        document.getElementById('musicToggle').textContent = '‚ô´';
                        document.getElementById('musicToggle').classList.remove('muted');
                    }).catch(e => {
                        console.log('Auto-play prevented:', e);
                    });
                    musicInitialized = true;
                    document.removeEventListener('click', playMusic);
                    document.removeEventListener('keydown', playMusic);
                    document.removeEventListener('touchstart', playMusic);
                };
                
                document.addEventListener('click', playMusic);
                document.addEventListener('keydown', playMusic);
                document.addEventListener('touchstart', playMusic);
            }
        }

        function toggleMusic() {
            const musicBtn = document.getElementById('musicToggle');
            
            if (isMusicPlaying) {
                backgroundMusic.pause();
                musicBtn.textContent = '‚ô™';
                musicBtn.classList.add('muted');
                isMusicPlaying = false;
            } else {
                backgroundMusic.play().then(() => {
                    musicBtn.textContent = '‚ô´';
                    musicBtn.classList.remove('muted');
                    isMusicPlaying = true;
                }).catch(e => {
                    console.log('Play failed:', e);
                    alert('Please interact with the page to enable audio');
                });
            }
        }
    </script>
</body>
</html>
